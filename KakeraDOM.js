/**
 * @license
 * Copyright (C) CABSOFTWARE.COM - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Seungchul Kang <ksc214@gmail.com>, November 2015
 * @module KakeraDOM
 * @version 1.1.0
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t):e.KakeraDOM=t()}(this,function(){function e(t,i){var n=i[t[0]];return t.length>1&&"undefined"!=typeof n?e(t.slice(1,t.length),n):n}function t(e,t,i){var n;for(n in t)n==i&&"classAlias"==n||(e[n]=t[n]);return e}function n(e,t,i){document.addEventListener?e.addEventListener(t,i,!1):e.attachEvent?e.attachEvent("on"+t,i):e["on"+t]=i}function s(e,t,i){document.removeEventListener?e.removeEventListener(t,i,!1):e.attachEvent?e.detachEvent("on"+t,i):e["on"+t]=null}function r(e,t,i){var s,r,l,o,a,u,c=function(e,i){return function(n){t[e].call(i,n)}};for(r in t)if(u=r.split(" "),l=u.splice(0,1)[0],o=u.join(" "),"string"==typeof l&&"string"==typeof o)for(a=e.querySelectorAll(o),s=0;s<a.length;s++){var h=c(r,i);n(a.item(s),l,h)}}function l(){}function o(){}var a=Date.now||function(){return(new Date).getTime()};!function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;l.subClass=function(i){function n(){!e&&this._init&&this._init.apply(this,arguments)}var s=this.prototype;e=!0;var r=new this;e=!1;for(var l in i)r[l]="function"==typeof i[l]&&"function"==typeof s[l]&&t.test(i[l])?function(e,t){return function(){var i=this._super;this._super=s[e];var n=t.apply(this,arguments);return this._super=i,n}}(l,i[l]):i[l];return n.prototype=r,n.constructor=n,n.subClass=this.subClass,i.classAlias&&(n.classAlias=i.classAlias),n}}();var u=l.subClass({_children:null,_debounceWait:100,template:null,init:function(){},render:function(){if(null===this.template)throw new Error("["+this.classAlias+"] 클래스의 template이 null 입니다. template을 설정하거나 render를 구현하셔야 합니다.");return"string"==typeof this.template?this.template:this.template.length>1?this.template[0]:void 0},makeEl:function(){var i,s,l,a,c,h,f,d=document.createElement("div"),p={};f={"this":this};for(var v in u.prototype)delete f[v];if(i=this.render(),"object"==typeof i&&(t(f,i.param),i=i.template),i=i.replace(/^[^\/]+\/\*!?/,"").replace(/\*\/[^\/]+$/,"").replace(/\s+</g,"<").replace(/>\s+/g,">"),this.deps){var m,v,y,g,_=/[\w]+/g;for(a=0;a<this.deps.length;a++){s=this.deps[a],"undefined"==typeof p[s.classAlias]&&(p[s.classAlias]=[]);var w=i.match(new RegExp("<\\s*"+s.classAlias+"(?:\\/>|\\s+(?:.|\\s)*?\\/>)","g"));if(null!==w){var b=new RegExp("{\\.\\.\\..+?}|(\\w*=([\"|']*).+?\\2|{.+})(?=\\s|(?=>)|(?=\\/>))","g");for(c=0;c<w.length;c++){var A=w[c].match(b);if(p[s.classAlias][c]={},null!==A){for(h=0;h<A.length;h++){var z=A[h];if(0===z.indexOf("{...")){v=z.substring(4,z.length-1),y=v.match(_).map(function(e){var t=parseInt(e);return isNaN(t)?e:t}),g=e(y,f);for(var C in g)g[C]="function"==typeof g[C]?g[C].bind(this):g[C];t(p[s.classAlias][c],g)}else-1!=z.indexOf("=")&&(m=z.split("="),v=m[0],g=m[1],"{"==g.charAt(0)?(y=g.substring(1,g.length-1).match(_).map(function(e){var t=parseInt(e);return isNaN(t)?e:t}),g=e(y,f),g="function"==typeof g?g.bind(this):g,p[s.classAlias][c][v]=g):"'"==g.charAt(0)||'"'==g.charAt(0)?p[s.classAlias][c][v]=g.substring(1,g.length-1):p[s.classAlias][c][v]=g)}i=i.replace(w[c],"<div vdom='"+s.classAlias+"'></div>")}else i=i.replace(w[c],"<div vdom='"+s.classAlias+"'></div>")}}}}if(i=i.replace(/<[^\/].+?>/g,function(e){return e.replace(/={.+?}(?=(\s|>))/g,function(e){return"='"+e.substring(1,e.length)+"'"})}),d.innerHTML=o.format(i,f),1!=d.childNodes.length)throw new Error("["+this.classAlias+"] 클래스는 하나의 엘레멘트로 작성되어야 합니다.");return this.el=d.firstChild,r(d,this.listener,this),i=null,f=null,d=null,window&&"function"==typeof this.onWindowResize&&(this._onWindowResize=function(e){var t=function(t){e.onWindowResize.call(e,t)};return o.debounce(t,e._debounceWait)}(this),n(window,"resize",this._onWindowResize)),this.deps&&setTimeout(function(){for(this._children={},a=0;a<this.deps.length;a++){var e=this.deps[a],t=this.el.querySelectorAll("div[vdom='"+e.classAlias+"']");for(c=0;c<t.length;c++){l=o.useFreeze?Object.freeze(p[e.classAlias][c]):o.deepObjCopy(p[e.classAlias][c]);var i=new e(l);this.addChild(i);var n=i.makeEl();i.willMount(),t.item(c).parentNode.replaceChild(n,t.item(c));var s=function(e){return function(){e.didMount()}}(i);setTimeout(s,o.delay)}e=null}o.useFreeze||(p=null)}.bind(this),o.delay),this.el},willMount:function(){},didMount:function(){},refresh:function(){setTimeout(function(){var e,t=this.el;this.removeAllChild(),this._onWindowResize&&(s(window,"resize",this._onWindowResize),this._onWindowResize=null,delete this._onWindowResize),e=this.makeEl(),this.willMount(),t.parentNode.replaceChild(e,t),setTimeout(function(){this.didMount()}.bind(this),o.delay)}.bind(this),o.delay)},children:function(e){var t;return null===this._children?null:(t="string"==typeof e?this._children.map[e]:"number"==typeof e?this._children.list[e]:this._children,"undefined"==typeof t?null:t)},addChild:function(e){this._children=this._children||{},this._children.list=this._children.list||[],this._children.list.push(e),this._children.map=this._children.map||{},"undefined"!=typeof this._children.map[e.classAlias]?this._children.map[e.classAlias].push(e):this._children.map[e.classAlias]=[e]},removeChild:function(e){var t,n,s,r;if(null!==this._children){if("number"==typeof e)t=e,s=this._children.list[t];else for(t=0;t<this._children.list.length;t++)this._children.list[t]===e&&(s=this._children.list[t]);if(s){for(r=this._children.map[s.classAlias],this._children.list.splice(t,1),n=0;i<r.length;n++)r[n]===s&&r.splice(n,1);s.release()}0===this._children.list.length&&(this._children=null)}},removeAllChild:function(){var e,t;if(null!==this._children){if("undefined"!=typeof this._children.list){e=this._children.list.length;for(var i=0;e>i;i++)t=this._children.list[i],t.release()}this._children=null}},release:function(){var e;if(null!==this._children){if(e=this._children.list,null!==e&&"undefined"!=typeof e)for(var t=0;t<e.length;t++)e[t].release();this._children=null}this._onWindowResize&&(s(window,"resize",this._onWindowResize),this._onWindowResize=null,delete this._onWindowResize),"function"==typeof this.destroy&&this.destroy(),this.el.parentNode.removeChild(this.el)}});return t(o,{delay:0,useFreeze:"function"==typeof Object.freeze,multiline:function(e){return e.toString().replace(/^[^\/]+\/\*!?/,"").replace(/\*\/[^\/]+$/,"").replace(/\s+</g,"<").replace(/>\s+/g,">")},format:function(){var t=arguments;if(2==arguments.length){if(arguments[1]instanceof Array)return arguments[0].replace(/{(\d+)}/g,function(e,i){return"undefined"!=typeof t[1][i]?t[1][i]:e});if(arguments[1]instanceof Object)return arguments[0].replace(/{[^}]+}/g,function(i,n){var s,r,l,o,a=i.substring(1,i.length-1),u=!1;if(a.length>3&&"..."==a.substring(0,3)&&(u=!0),u){s="",a=a.substring(3),l=a.match(/[\w]+/g).map(function(e){var t=parseInt(e);return isNaN(t)?e:t}),o=e(l,t[1]);for(r in o)s+=r+'="'+o[r]+'" ';return""!==s?s:i}return l=a.match(/[\w]+/g).map(function(e){var t=parseInt(e);return isNaN(t)?e:t}),o=e(l,t[1]),"undefined"!=typeof o?o:i})}return arguments[0].replace(/{(\d+)}/g,function(e,i){return"undefined"!=typeof t[Number(i)+1]?t[Number(i)+1]:e})},extend:function(e,t){var i;for(i in t)e[i]=t[i];return e},deepObjCopy:function(e){var t={};if("object"==typeof e){if("undefined"!=typeof e.length)var t=new Array;for(var i in e){var n=typeof e[i];switch(n){case"object":t[i]=o.deepObjCopy(e[i]);break;case"boolean":1==e[i]?t[i]=!0:t[i]=!1;break;default:t[i]=e[i]}}}return t},debounce:function(e,t,i){var n,s,r,l,o,u=function(){var c=a()-l;t>c&&c>=0?n=setTimeout(u,t-c):(n=null,i||(o=e.apply(r,s),n||(r=s=null)))};return function(){r=this,s=arguments,l=a();var c=i&&!n;return n||(n=setTimeout(u,t)),c&&(o=e.apply(r,s),r=s=null),o}},render:function(e,t){if("object"!=typeof e)throw new Error("객체 타입["+typeof e+"]이 유효하지 않습니다.");if(null===t)throw new Error("랜더링 타겟 엘레멘트가 존재하지 않습니다.");var i=e.makeEl();e.willMount(),t.appendChild(i),setTimeout(function(){e.didMount()},0)},createClass:function(e,i){var n={_init:function(e){this.props=e,"function"==typeof this.init&&this.init()}},s=i.mixins;if(s)for(var r in s)t(n,s[r]);t(n,i,"mixins"),n.classAlias=e;var l;return l=u.subClass(n),l.classAlias=e,l}}),o});